<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ë¨¸ë¦¬ê°€ ì¢‹ì•„ì§€ëŠ” ì‚°ìˆ˜ì‚°ìˆ˜</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- ê²Œì„ ë¡œì§ ë° ìŠ¤ì½”ì–´ë§ ëª¨ë“ˆ -->
    <script src="game-logic.js"></script>
    <script src="scoring.js"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getFirestore, collection, addDoc, query, orderBy, limit, getDocs, serverTimestamp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';
        
        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyAkZ9POBOYUIseY1No97Z407WV2-DKLdQw",
            authDomain: "math-plus-303a1.firebaseapp.com",
            projectId: "math-plus-303a1",
            storageBucket: "math-plus-303a1.firebasestorage.app",
            messagingSenderId: "76435894401",
            appId: "1:76435894401:web:5dcb2daae2b7312f5d9d80"
        };
        
        // Firebase ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        // ì „ì—­ ë³€ìˆ˜ë¡œ export
        window.firebaseDb = db;
        window.firebaseAddDoc = addDoc;
        window.firebaseCollection = collection;
        window.firebaseQuery = query;
        window.firebaseOrderBy = orderBy;
        window.firebaseLimit = limit;
        window.firebaseGetDocs = getDocs;
        window.firebaseServerTimestamp = serverTimestamp;
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Jua&display=swap" rel="stylesheet">
    <style>
        body { 
            font-family: 'Jua', sans-serif; 
            background: linear-gradient(135deg, #f3e8ff 0%, #fce7f3 50%, #fdf2f8 100%);
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }
        .game-card { 
            transition: all 0.3s ease; 
        }
        .wrong { 
            animation: shake 0.125s; 
            background-color: #fee2e2 !important;
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-15px) rotate(-2deg); }
            20%, 40%, 60%, 80% { transform: translateX(15px) rotate(2deg); }
        }
        .praise-text {
            position: fixed;
            top: 30%;
            left: 50%;
            transform: translateX(-50%);
            font-size: 4rem;
            font-weight: bold;
            color: #a855f7;
            text-shadow: 3px 3px 0px #fff, 6px 6px 10px rgba(0,0,0,0.2);
            z-index: 1000;
            animation: praisePop 1s ease-out forwards;
            pointer-events: none;
        }
        @keyframes praisePop {
            0% { 
                transform: translateX(-50%) scale(0.5) rotate(-10deg);
                opacity: 0;
            }
            50% { 
                transform: translateX(-50%) scale(1.2) rotate(5deg);
                opacity: 1;
            }
            100% { 
                transform: translateX(-50%) scale(1) rotate(0deg);
                opacity: 0;
            }
        }
        .combo-special {
            animation: comboBounce 0.6s ease-out;
            font-size: 4rem !important;
            color: #ec4899 !important;
            text-shadow: 0 0 20px rgba(236, 72, 153, 0.8);
        }
        @keyframes comboBounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.3); }
        }
        .score-bounce {
            animation: scoreBounce 0.5s ease-out;
        }
        @keyframes scoreBounce {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.4) rotate(5deg); }
        }
        #correct-answer {
            font-size: 4rem !important;
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .score-change {
            position: absolute;
            right: 0;
            top: 0;
            font-size: 1.8rem;
            font-weight: bold;
            z-index: 100;
            pointer-events: none;
            animation: scoreChangePop 1.2s ease-out forwards;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        @keyframes scoreChangePop {
            0% {
                opacity: 0;
                transform: translateY(0) translateX(0) scale(0.5);
            }
            15% {
                opacity: 1;
                transform: translateY(-10px) translateX(0) scale(1.3);
            }
            50% {
                opacity: 1;
                transform: translateY(-30px) translateX(0) scale(1.1);
            }
            100% {
                opacity: 0;
                transform: translateY(-60px) translateX(10px) scale(0.8);
            }
        }
        @media (max-width: 640px) {
            #correct-answer { font-size: 2.5rem !important; }
            .score-change { font-size: 1.2rem; }
        }
        button {
            font-size: 2rem !important;
            padding: 1.5rem 2rem !important;
            min-height: 80px;
        }
        input[type="number"] {
            font-size: 4rem !important;
            min-height: 100px;
        }
        input[type="text"] {
            font-size: 1.5rem !important;
            padding: 1rem !important;
        }
        .number-display {
            font-size: 6rem !important;
        }
        .ranking-item {
            transition: all 0.2s ease;
        }
        .ranking-item:hover {
            transform: scale(1.02);
            background-color: #faf5ff;
        }
        @media (max-width: 640px) {
            .number-display { font-size: 3.5rem !important; }
            input[type="number"] { font-size: 2.5rem !important; min-height: 70px; }
            button { font-size: 1.3rem !important; padding: 1rem 1.2rem !important; min-height: 60px; }
            input[type="text"] { font-size: 1.2rem !important; padding: 0.8rem !important; }
            h1 { font-size: 2.5rem !important; }
            .ranking-item { font-size: 0.9rem !important; }
        }
        @media (max-width: 480px) {
            .number-display { font-size: 3rem !important; }
            input[type="number"] { font-size: 2rem !important; min-height: 60px; }
            button { font-size: 1.1rem !important; padding: 0.9rem 1rem !important; min-height: 55px; }
        }
        .creator-badge {
            position: fixed;
            top: 10px;
            left: 10px;
            background: linear-gradient(135deg, #f3e8ff 0%, #fce7f3 100%);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            color: #9333ea;
            border: 2px solid #e9d5ff;
            box-shadow: 0 2px 8px rgba(147, 51, 234, 0.2);
            z-index: 1000;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        .creator-badge:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(147, 51, 234, 0.3);
        }
        @media (max-width: 640px) {
            .creator-badge {
                font-size: 0.75rem;
                padding: 5px 10px;
                top: 8px;
                left: 8px;
            }
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen p-2 sm:p-4">

    <div class="creator-badge">ğŸ’œ ë‘¥ë‘¥ì´ë“¤ì•„ë¹ </div>

    <div id="username-screen" class="text-center bg-white p-6 sm:p-8 md:p-12 rounded-3xl shadow-2xl max-w-2xl w-full border-4 border-purple-200">
        <h1 class="text-4xl sm:text-5xl md:text-6xl bg-gradient-to-r from-purple-500 to-pink-500 bg-clip-text text-transparent mb-4">ğŸ”¢ ë¨¸ë¦¬ê°€ ì¢‹ì•„ì§€ëŠ” ì‚°ìˆ˜ì‚°ìˆ˜</h1>
        <p class="text-gray-500 text-base sm:text-lg md:text-xl mb-6 italic">ì–´ë ¤ìš¸ìˆ˜ë¡ ì ìˆ˜ê°€ ë†’ì•„ì ¸ìš”!</p>
        <div class="mb-6">
            <label for="username-input" class="block text-lg sm:text-xl md:text-2xl text-gray-700 mb-3">ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”</label>
            <input type="text" id="username-input" class="w-full text-center border-4 border-purple-300 rounded-2xl focus:border-pink-500 outline-none transition-all" placeholder="ê½ê½ì´" maxlength="10">
        </div>
        <button onclick="saveUsername()" class="w-full bg-gradient-to-r from-purple-400 to-pink-500 hover:from-purple-500 hover:to-pink-600 text-white rounded-3xl shadow-xl transition-all transform hover:scale-105 active:scale-95 border-4 border-purple-200 text-xl sm:text-2xl py-3 sm:py-4 mb-4 sm:mb-6">
            ì‹œì‘í•˜ê¸° ğŸš€
        </button>
        
        <div id="username-ranking-section" class="mt-4 sm:mt-6">
            <h3 class="text-xl sm:text-2xl md:text-3xl text-purple-600 font-bold mb-3 sm:mb-4">ğŸ† ì—­ëŒ€ ë­í‚¹ Top 10</h3>
            <div id="username-ranking-list" class="space-y-2">
                <!-- ë­í‚¹ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
        </div>
    </div>

    <div id="lobby" class="hidden text-center bg-white p-6 sm:p-8 md:p-12 rounded-3xl shadow-2xl max-w-2xl w-full border-4 border-purple-200">
        <h1 class="text-4xl sm:text-5xl md:text-6xl bg-gradient-to-r from-purple-500 to-pink-500 bg-clip-text text-transparent mb-4">ğŸ”¢ ë¨¸ë¦¬ê°€ ì¢‹ì•„ì§€ëŠ” ì‚°ìˆ˜ì‚°ìˆ˜</h1>
        <p class="text-gray-500 text-base sm:text-lg md:text-xl mb-2 italic">ì–´ë ¤ìš¸ìˆ˜ë¡ ì ìˆ˜ê°€ ë†’ì•„ì ¸ìš”!</p>
        <p class="text-gray-600 mb-4 sm:mb-6 text-xl sm:text-2xl md:text-3xl">60ì´ˆ ë™ì•ˆ ëª‡ ë¬¸ì œë¥¼ ë§ì¶œ ìˆ˜ ìˆì„ê¹Œ? ğŸš€</p>
        <div class="mb-4 sm:mb-6">
            <label for="lobby-username-input" class="block text-base sm:text-lg md:text-xl text-gray-700 mb-2">í”Œë ˆì´ì–´ ì´ë¦„</label>
            <input type="text" id="lobby-username-input" class="w-full text-center border-4 border-purple-300 rounded-2xl focus:border-pink-500 outline-none transition-all text-lg sm:text-xl md:text-2xl py-2 sm:py-3" placeholder="ê½ê½ì´" maxlength="10">
        </div>
        <div class="space-y-3 sm:space-y-5">
            <button onclick="startGame(1)" class="w-full bg-gradient-to-r from-purple-300 to-purple-400 hover:from-purple-400 hover:to-purple-500 text-white rounded-3xl shadow-xl transition-all transform hover:scale-105 active:scale-95 border-4 border-purple-200 text-lg sm:text-xl md:text-2xl py-3 sm:py-4">
                âœ¨ Level 1: ì˜¬ë¦¼ì´ ì—†ëŠ” í•œìë¦¬ ë”í•˜ê¸°
            </button>
            <button onclick="startGame(2)" class="w-full bg-gradient-to-r from-pink-300 to-rose-400 hover:from-pink-400 hover:to-rose-500 text-white rounded-3xl shadow-xl transition-all transform hover:scale-105 active:scale-95 border-4 border-pink-200 text-lg sm:text-xl md:text-2xl py-3 sm:py-4">
                ğŸ”¥ Level 2: ì˜¬ë¦¼ì´ ìˆëŠ” í•œìë¦¬ ë”í•˜ê¸°
            </button>
            <button onclick="startGame(3)" class="w-full bg-gradient-to-r from-violet-300 to-purple-400 hover:from-violet-400 hover:to-purple-500 text-white rounded-3xl shadow-xl transition-all transform hover:scale-105 active:scale-95 border-4 border-violet-200 text-lg sm:text-xl md:text-2xl py-3 sm:py-4">
                ğŸ’ª Level 3: 20 ì´í•˜ ë”í•˜ê¸°
            </button>
            <button onclick="startGame(4)" class="w-full bg-gradient-to-r from-indigo-300 to-purple-400 hover:from-indigo-400 hover:to-purple-500 text-white rounded-3xl shadow-xl transition-all transform hover:scale-105 active:scale-95 border-4 border-indigo-200 text-lg sm:text-xl md:text-2xl py-3 sm:py-4">
                ğŸ¯ Level 4: ë‘ìë¦¬ ë‘ìë¦¬ ë”í•˜ê¸°
            </button>
        </div>
    </div>

    <div id="game" class="hidden text-center bg-white p-4 sm:p-8 md:p-12 rounded-3xl shadow-2xl max-w-2xl w-full border-4 border-purple-200 relative">
        <div class="flex justify-between items-center mb-4 sm:mb-6 flex-wrap gap-2 sm:gap-4">
            <div id="timer" class="text-2xl sm:text-3xl md:text-4xl lg:text-5xl text-red-500 font-bold">â± <span id="time-value">60</span>ì´ˆ</div>
            <div id="score" class="text-2xl sm:text-3xl md:text-4xl text-purple-500 font-bold relative">ì ìˆ˜: <span id="score-value">0</span></div>
        </div>
        
        <div class="mb-3 sm:mb-4">
            <div id="combo-display" class="h-8 sm:h-12 md:h-16 text-pink-500 text-2xl sm:text-3xl md:text-4xl font-bold"></div>
            <div id="correct-count" class="text-xl sm:text-2xl md:text-3xl text-violet-500 font-bold">ë§ì¶˜ ê°œìˆ˜: <span id="correct-value">0</span></div>
        </div>
        
        <div id="question-card" class="game-card bg-gradient-to-br from-purple-50 to-pink-50 p-6 sm:p-10 md:p-16 rounded-3xl mb-4 sm:mb-6 border-4 border-purple-100">
            <div id="question" class="number-display mb-4 sm:mb-6 text-gray-800">2 + 3</div>
            <div id="correct-answer" class="number-display mb-2 text-red-500 hidden"></div>
            <input type="text" id="answer" inputmode="numeric" pattern="[0-9]*" class="w-full text-center border-b-4 border-purple-300 bg-transparent outline-none focus:border-pink-500 transition-all" placeholder="?" autofocus>
        </div>
        
        <p class="text-gray-500 italic text-base sm:text-xl md:text-2xl">ì •ë‹µì„ ì“°ë©´ ìë™ìœ¼ë¡œ ë„˜ì–´ê°€ìš”! âœ¨</p>
    </div>

    <div id="result" class="hidden text-center bg-white p-4 sm:p-8 md:p-12 rounded-3xl shadow-2xl max-w-2xl w-full border-4 border-pink-200">
        <h2 class="text-3xl sm:text-4xl md:text-5xl lg:text-6xl bg-gradient-to-r from-purple-500 to-pink-500 bg-clip-text text-transparent mb-4 sm:mb-6">ğŸ– ë„ì „ ì™„ë£Œ!</h2>
        <div class="mb-4 sm:mb-6">
            <div id="final-score" class="text-5xl sm:text-6xl md:text-7xl lg:text-8xl text-purple-600 mb-2 sm:mb-4 font-bold">0ì </div>
            <div id="final-correct" class="text-2xl sm:text-3xl md:text-4xl lg:text-5xl text-pink-600 mb-2 sm:mb-4 font-bold">ë§ì¶˜ ê°œìˆ˜: 0ê°œ</div>
            <div id="final-accuracy" class="text-xl sm:text-2xl md:text-3xl text-violet-600 mb-2 sm:mb-4 font-bold">ì •ë‹µë¥ : 0%</div>
        </div>
        <p id="best-score" class="text-lg sm:text-xl md:text-2xl lg:text-3xl text-gray-600 mb-4 sm:mb-8"></p>
        
        <button onclick="goToLobby()" class="w-full bg-gradient-to-r from-purple-400 to-pink-500 hover:from-purple-500 hover:to-pink-600 text-white rounded-3xl shadow-xl transition-all transform hover:scale-105 active:scale-95 border-4 border-purple-200 text-lg sm:text-xl md:text-2xl py-3 sm:py-4 mb-4 sm:mb-6">
            ë‹¤ì‹œ ë„ì „í•˜ê¸° ğŸš€
        </button>
        
        <div id="ranking-section" class="mb-4 sm:mb-6">
            <h3 class="text-2xl sm:text-3xl md:text-4xl text-purple-600 font-bold mb-3 sm:mb-4">ğŸ† ì—­ëŒ€ ë­í‚¹ Top 10</h3>
            <div id="ranking-list" class="space-y-2">
                <!-- ë­í‚¹ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
            </div>
        </div>
    </div>

    <script>
        // ê²Œì„ ëª¨ë“ˆ ì¸ìŠ¤í„´ìŠ¤
        const gameLogic = new GameLogic();
        const scoring = new ScoringSystem();
        
        // ê²Œì„ ìƒíƒœ
        let timeLeft = 60;
        let timerInterval;
        let difficulty = 1;
        let isWrong = false;
        let currentUsername = 'ê½ê½ì´';

        // ìœ ì €ë„¤ì„ í™”ë©´ìš© ë­í‚¹ í‘œì‹œ
        async function displayUsernameRanking() {
            const ranking = await getRanking();
            const rankingList = document.getElementById('username-ranking-list');
            
            if (ranking.length === 0) {
                rankingList.innerHTML = '<p class="text-gray-400 text-sm sm:text-base">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            // Top 10ê¹Œì§€ë§Œ í‘œì‹œ
            const top10 = ranking.slice(0, 10);
            
            rankingList.innerHTML = top10.map((record, index) => {
                const date = new Date(record.date);
                const dateStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                
                return `
                    <div class="ranking-item bg-gradient-to-r from-purple-50 to-pink-50 p-2 sm:p-3 rounded-2xl border-2 border-purple-200">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="text-lg sm:text-xl font-bold ${index === 0 ? 'text-yellow-500' : index === 1 ? 'text-gray-400' : index === 2 ? 'text-orange-600' : 'text-purple-500'}">
                                    ${index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}.`}
                                </span>
                                <span class="text-sm sm:text-base md:text-lg font-bold text-gray-800">${record.username}</span>
                            </div>
                            <div class="text-right">
                                <div class="text-sm sm:text-base font-bold text-purple-600">${record.score}ì </div>
                                <div class="text-xs text-gray-500">${record.correctCount}ê°œ | ${dateStr}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìœ ì €ë„¤ì„ ë¶ˆëŸ¬ì˜¤ê¸° ë° ë­í‚¹ í‘œì‹œ
        window.addEventListener('DOMContentLoaded', async () => {
            const savedUsername = localStorage.getItem('mathUsername');
            if (savedUsername) {
                currentUsername = savedUsername;
                document.getElementById('username-input').value = savedUsername;
            }
            document.getElementById('username-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    saveUsername();
                }
            });
            
            // ë­í‚¹ í‘œì‹œ
            await displayUsernameRanking();
        });

        function saveUsername() {
            const input = document.getElementById('username-input');
            const username = input.value.trim() || 'ê½ê½ì´';
            currentUsername = username;
            localStorage.setItem('mathUsername', username);
            
            document.getElementById('username-screen').classList.add('hidden');
            document.getElementById('lobby').classList.remove('hidden');
            document.getElementById('current-username').innerText = `í”Œë ˆì´ì–´: ${username}`;
        }

        function goToLobby() {
            document.getElementById('result').classList.add('hidden');
            document.getElementById('game').classList.add('hidden');
            document.getElementById('username-screen').classList.add('hidden');
            document.getElementById('lobby').classList.remove('hidden');
            
            // ë¡œë¹„ í™”ë©´ì˜ ì´ë¦„ ì…ë ¥ í•„ë“œì— í˜„ì¬ ì´ë¦„ í‘œì‹œ
            const lobbyInput = document.getElementById('lobby-username-input');
            lobbyInput.value = currentUsername;
            
            // ë¡œë¹„ í™”ë©´ ì´ë¦„ ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            lobbyInput.addEventListener('input', (e) => {
                const newUsername = e.target.value.trim() || 'ê½ê½ì´';
                currentUsername = newUsername;
                localStorage.setItem('mathUsername', newUsername);
            });
            
            lobbyInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    const newUsername = e.target.value.trim() || 'ê½ê½ì´';
                    currentUsername = newUsername;
                    localStorage.setItem('mathUsername', newUsername);
                    e.target.blur();
                }
            });
        }

        // Firebase ì‚¬ìš© ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
        function isFirebaseAvailable() {
            return window.firebaseDb && window.firebaseAddDoc && window.firebaseCollection;
        }

        // LocalStorageì—ì„œ ë­í‚¹ ê°€ì ¸ì˜¤ê¸° (Fallback)
        function getRankingLocal() {
            const ranking = localStorage.getItem('mathRanking');
            return ranking ? JSON.parse(ranking) : [];
        }

        // Firebaseì—ì„œ ë­í‚¹ ê°€ì ¸ì˜¤ê¸°
        async function getRankingFirebase() {
            try {
                if (!isFirebaseAvailable()) {
                    console.log('Firebase ì‚¬ìš© ë¶ˆê°€, LocalStorageì—ì„œ ë­í‚¹ ê°€ì ¸ì˜¤ê¸°');
                    return getRankingLocal();
                }
                
                // Firebaseì—ì„œëŠ” í•˜ë‚˜ì˜ orderByë§Œ ì‚¬ìš© ê°€ëŠ¥í•˜ë¯€ë¡œ, ì ìˆ˜ë¡œë§Œ ì •ë ¬ í›„ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì¶”ê°€ ì •ë ¬
                const q = window.firebaseQuery(
                    window.firebaseCollection(window.firebaseDb, 'rankings'),
                    window.firebaseOrderBy('score', 'desc'),
                    window.firebaseLimit(50) // ì¶©ë¶„íˆ ë§ì´ ê°€ì ¸ì˜¨ í›„ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì •ë ¬
                );
                
                const querySnapshot = await window.firebaseGetDocs(q);
                const ranking = [];
                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    ranking.push({
                        id: doc.id,
                        username: data.username,
                        score: data.score,
                        correctCount: data.correctCount,
                        date: data.date?.toDate ? data.date.toDate().toISOString() : data.date
                    });
                });
                
                console.log(`Firebaseì—ì„œ ${ranking.length}ê°œì˜ ë­í‚¹ ê°€ì ¸ì˜´`);
                
                // í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì ìˆ˜ë¡œ ì •ë ¬ í›„, ê°™ì€ ì ìˆ˜ë©´ correctCountë¡œ ì •ë ¬
                ranking.sort((a, b) => {
                    if (b.score !== a.score) {
                        return b.score - a.score;
                    }
                    return b.correctCount - a.correctCount;
                });
                
                // Top 10ë§Œ ë°˜í™˜
                const top10 = ranking.slice(0, 10);
                console.log('Top 10 ë­í‚¹:', top10);
                return top10;
            } catch (error) {
                console.error('Firebase ë­í‚¹ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
                return getRankingLocal();
            }
        }

        // Firebaseì— ë­í‚¹ ì¶”ê°€
        async function addToRankingFirebase(username, score, correctCount) {
            try {
                if (!isFirebaseAvailable()) {
                    console.log('Firebase ì‚¬ìš© ë¶ˆê°€, LocalStorage ì‚¬ìš©');
                    return addToRankingLocal(username, score, correctCount);
                }
                
                console.log('Firebaseì— ë­í‚¹ ì¶”ê°€ ì¤‘:', { username, score, correctCount });
                
                await window.firebaseAddDoc(
                    window.firebaseCollection(window.firebaseDb, 'rankings'),
                    {
                        username: username,
                        score: score,
                        correctCount: correctCount,
                        date: window.firebaseServerTimestamp()
                    }
                );
                
                console.log('Firebase ë­í‚¹ ì¶”ê°€ ì™„ë£Œ');
                
                // ë­í‚¹ ì¶”ê°€ í›„ ì•½ê°„ì˜ ì§€ì—°ì„ ë‘ê³  ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸°
                await new Promise(resolve => setTimeout(resolve, 300));
                
                return await getRankingFirebase();
            } catch (error) {
                console.error('Firebase ë­í‚¹ ì €ì¥ ì‹¤íŒ¨:', error);
                return addToRankingLocal(username, score, correctCount);
            }
        }

        // LocalStorageì— ë­í‚¹ ì¶”ê°€ (Fallback)
        function addToRankingLocal(username, score, correctCount) {
            let ranking = getRankingLocal();
            const newRecord = {
                username: username,
                score: score,
                correctCount: correctCount,
                date: new Date().toISOString()
            };
            ranking.push(newRecord);
            
            ranking.sort((a, b) => {
                if (b.score !== a.score) {
                    return b.score - a.score;
                }
                return b.correctCount - a.correctCount;
            });
            
            ranking = ranking.slice(0, 10);
            localStorage.setItem('mathRanking', JSON.stringify(ranking));
            return ranking;
        }

        // í†µí•© ë­í‚¹ í•¨ìˆ˜ë“¤
        async function getRanking() {
            return await getRankingFirebase();
        }

        async function addToRanking(username, score, correctCount) {
            return await addToRankingFirebase(username, score, correctCount);
        }

        function findCurrentRank(ranking, username, score, correctCount) {
            // ë­í‚¹ì—ì„œ í˜„ì¬ ê¸°ë¡ê³¼ ì¼ì¹˜í•˜ëŠ” í•­ëª© ì°¾ê¸°
            // ì ìˆ˜ì™€ ë§ì¶˜ ê°œìˆ˜ê°€ ì •í™•íˆ ì¼ì¹˜í•˜ëŠ” í•­ëª© ì¤‘ ê°€ì¥ ìµœê·¼ ê²ƒì„ ì°¾ìŒ
            let currentRecordIndex = -1;
            let maxDate = 0;
            
            for (let i = 0; i < ranking.length; i++) {
                if (ranking[i].username === username && 
                    ranking[i].score === score && 
                    ranking[i].correctCount === correctCount) {
                    const recordDate = new Date(ranking[i].date).getTime();
                    if (recordDate > maxDate) {
                        maxDate = recordDate;
                        currentRecordIndex = i;
                    }
                }
            }
            
            // ì°¾ì•˜ìœ¼ë©´ ì¸ë±ìŠ¤ + 1 ë°˜í™˜ (1ë“±ë¶€í„° ì‹œì‘)
            if (currentRecordIndex !== -1) {
                return currentRecordIndex + 1;
            }
            
            // ì°¾ì§€ ëª»í–ˆìœ¼ë©´ ì ìˆ˜ ê¸°ì¤€ìœ¼ë¡œ ìˆœìœ„ ê³„ì‚°
            // í˜„ì¬ ì ìˆ˜ë³´ë‹¤ ë†’ì€ ì ìˆ˜ë¥¼ ê°€ì§„ ê¸°ë¡ì˜ ê°œìˆ˜ë¥¼ ì„¸ì–´ì„œ ìˆœìœ„ ê³„ì‚°
            let rank = 1;
            for (let i = 0; i < ranking.length; i++) {
                if (ranking[i].score > score || 
                    (ranking[i].score === score && ranking[i].correctCount > correctCount)) {
                    rank++;
                }
            }
            
            // í˜„ì¬ ê¸°ë¡ì´ ë­í‚¹ì— ì—†ì§€ë§Œ Top 10 ì•ˆì— ë“¤ì–´ê°ˆ ìˆ˜ ìˆëŠ” ê²½ìš°
            // (ì˜ˆ: 1ë“±ì„ ë„˜ì–´ì„  ê¸°ë¡)
            if (rank <= 10) {
                return rank;
            }
            
            // Top 10 ë°–ì´ë©´ -1 ë°˜í™˜
            return -1;
        }

        async function displayRanking() {
            const ranking = await getRanking();
            const rankingList = document.getElementById('ranking-list');
            const stats = scoring.getStats();
            
            if (ranking.length === 0) {
                rankingList.innerHTML = '<p class="text-gray-400 text-lg">ì•„ì§ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }
            
            // ìµœëŒ€ 10ê°œê¹Œì§€ í‘œì‹œ
            const displayRanking = ranking.slice(0, 10);
            
            rankingList.innerHTML = displayRanking.map((record, index) => {
                const date = new Date(record.date);
                const dateStr = `${date.getMonth() + 1}/${date.getDate()} ${date.getHours()}:${String(date.getMinutes()).padStart(2, '0')}`;
                const isCurrent = record.username === currentUsername && 
                                 record.score === stats.score && 
                                 record.correctCount === stats.correctCount;
                
                return `
                    <div class="ranking-item bg-gradient-to-r from-purple-50 to-pink-50 p-3 sm:p-4 rounded-2xl border-2 ${isCurrent ? 'border-pink-400 ring-2 ring-pink-300' : 'border-purple-200'}">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2 sm:gap-3">
                                <span class="text-2xl sm:text-3xl font-bold ${index === 0 ? 'text-yellow-500' : index === 1 ? 'text-gray-400' : index === 2 ? 'text-orange-600' : 'text-purple-500'}">
                                    ${index === 0 ? 'ğŸ¥‡' : index === 1 ? 'ğŸ¥ˆ' : index === 2 ? 'ğŸ¥‰' : `${index + 1}.`}
                                </span>
                                <span class="text-lg sm:text-xl md:text-2xl font-bold text-gray-800">${record.username}</span>
                                ${isCurrent ? '<span class="text-pink-500 text-sm sm:text-base">âœ¨</span>' : ''}
                            </div>
                            <div class="text-right">
                                <div class="text-base sm:text-lg md:text-xl font-bold text-purple-600">${record.score}ì </div>
                                <div class="text-xs sm:text-sm text-gray-500">${record.correctCount}ê°œ | ${dateStr}</div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        const praiseMessages = [
            'ì™„ë²½í•´! âœ¨',
            'ì—°ì‚° ì²œì¬! ğŸŒŸ',
            'ê¸°ì´ˆê°€ íŠ¼íŠ¼í•´ì§€ê³  ìˆì–´! ğŸ’ª',
            'ì°¢ì—ˆë‹¤..âœ¨',
            'ëŒ€ë°•! ğŸ”¥',
            'ì™„ì „ ë©‹ì ¸! ğŸ‰',
            'ë ˆì „ë“œ! ğŸ‘‘',
            'ì§„ì§œ ì©”ì–´! ğŸ’¥',
            'ê°œê¿€ì¼! ğŸŠ',
            'ìµœê³ ì•¼! ğŸŒˆ',
            'ì™„ì „ ì²œì¬! ğŸš€',
            'ê¸°ì´ˆ ì™„ë²½! ğŸ’¯'
        ];

        function startGame(level) {
            // ë¡œë¹„ í™”ë©´ì—ì„œ ì´ë¦„ ì—…ë°ì´íŠ¸
            const lobbyInput = document.getElementById('lobby-username-input');
            if (lobbyInput) {
                const newUsername = lobbyInput.value.trim() || 'ê½ê½ì´';
                currentUsername = newUsername;
                localStorage.setItem('mathUsername', newUsername);
            }
            
            difficulty = level;
            scoring.reset();
            timeLeft = 60;
            isWrong = false;
            
            document.getElementById('lobby').classList.add('hidden');
            document.getElementById('game').classList.remove('hidden');
            document.getElementById('result').classList.add('hidden');
            
            document.getElementById('score-value').innerText = '0';
            document.getElementById('correct-value').innerText = '0';
            document.getElementById('time-value').innerText = '60';
            document.getElementById('combo-display').innerText = '';
            document.getElementById('combo-display').classList.remove('combo-special');
            
            const gameCard = document.getElementById('question-card');
            gameCard.classList.remove('wrong');
            
            nextQuestion();
            startTimer();
            document.getElementById('answer').focus();
        }

        function nextQuestion() {
            // ê²Œì„ ë¡œì§ ëª¨ë“ˆì„ ì‚¬ìš©í•˜ì—¬ ë¬¸ì œ ìƒì„±
            const question = gameLogic.generateQuestion(difficulty);
            scoring.setLevelMultiplier(question.multiplier);
            
            document.getElementById('question').innerText = `${question.n1} ${question.operator} ${question.n2}`;
            document.getElementById('answer').value = '';
            document.getElementById('answer').disabled = false;
            document.getElementById('correct-answer').classList.add('hidden');
            isWrong = false;
            
            const gameCard = document.getElementById('question-card');
            gameCard.classList.remove('wrong');
            
            // í¬ì»¤ìŠ¤ ë‹¤ì‹œ ì£¼ê¸°
            setTimeout(() => {
                document.getElementById('answer').focus();
            }, 100);
        }

        function showPraise() {
            const praise = document.createElement('div');
            praise.className = 'praise-text';
            praise.innerText = praiseMessages[Math.floor(Math.random() * praiseMessages.length)];
            document.body.appendChild(praise);
            
            setTimeout(() => {
                if (document.body.contains(praise)) {
                    document.body.removeChild(praise);
                }
            }, 1000);
        }

        function showCombo(combo) {
            const cd = document.getElementById('combo-display');
            // 5, 10, 15, 20 ë“± íŠ¹ì • ì½¤ë³´ì—ì„œë§Œ í‘œì‹œ
            if (combo === 5 || combo === 10 || combo === 15 || combo === 20 || combo % 10 === 0) {
                cd.innerText = `${combo} COMBO! ğŸ”¥`;
                cd.classList.add('combo-special');
                confetti({ 
                    particleCount: 100, 
                    spread: 90, 
                    origin: { y: 0.4 },
                    colors: ['#a855f7', '#ec4899', '#f472b6', '#c084fc']
                });
                setTimeout(() => {
                    cd.classList.remove('combo-special');
                }, 600);
            } else if (combo > 1) {
                // ì¼ë°˜ ì½¤ë³´ëŠ” ì‘ê²Œ í‘œì‹œ
                cd.innerText = `${combo} COMBO`;
            } else {
                cd.innerText = '';
            }
        }

        function animateScore() {
            const scoreElement = document.getElementById('score-value');
            scoreElement.classList.add('score-bounce');
            setTimeout(() => {
                scoreElement.classList.remove('score-bounce');
            }, 500);
        }

        function showScoreChange(change) {
            const scoreContainer = document.getElementById('score');
            const changeElement = document.createElement('div');
            changeElement.className = 'score-change';
            changeElement.innerText = change > 0 ? `+${change}` : `${change}`;
            changeElement.style.color = change > 0 ? '#10b981' : '#ef4444';
            scoreContainer.appendChild(changeElement);
            
            setTimeout(() => {
                if (scoreContainer.contains(changeElement)) {
                    scoreContainer.removeChild(changeElement);
                }
            }, 1200);
        }

        // ê³µí†µ ì •ë‹µ ì²´í¬ í•¨ìˆ˜
        function checkAnswer(userAnswer, userInputString) {
            return gameLogic.checkAnswer(userAnswer, userInputString);
        }

        // ì •ë‹µ ì²˜ë¦¬ í•¨ìˆ˜
        function handleCorrectAnswer() {
            if (isWrong) return;
            
            const result = scoring.handleCorrect();
            
            showScoreChange(result.scoreChange);
            showCombo(result.combo);
            
            // íŠ¹ì • ì½¤ë³´ì—ì„œë§Œ confetti íš¨ê³¼
            if (result.isSpecialCombo) {
                animateScore();
            }
            
            document.getElementById('score-value').innerText = result.totalScore;
            document.getElementById('correct-value').innerText = result.correctCount;
            
            setTimeout(() => {
                nextQuestion();
            }, 150);
        }

        // ì˜¤ë‹µ ì²˜ë¦¬ í•¨ìˆ˜
        function handleWrongAnswer(inputElement) {
            if (isWrong) return;
            
            isWrong = true;
            const result = scoring.handleWrong();
            
            showScoreChange(result.scoreChange);
            const gameCard = document.getElementById('question-card');
            gameCard.classList.add('wrong');
            document.getElementById('combo-display').innerText = '';
            document.getElementById('score-value').innerText = result.totalScore;
            
            // ì •ë‹µì„ ë¹¨ê°„ ê¸€ì”¨ë¡œ í‘œì‹œ
            const correctAnswerDiv = document.getElementById('correct-answer');
            correctAnswerDiv.innerText = `ì •ë‹µ: ${gameLogic.getCurrentAnswer()}`;
            correctAnswerDiv.classList.remove('hidden');
            inputElement.disabled = true;
            
            // 0.375ì´ˆ í›„ ë‹¤ìŒ ë¬¸ì œë¡œ (1.5ì´ˆì˜ 1/4)
            setTimeout(() => {
                gameCard.classList.remove('wrong');
                correctAnswerDiv.classList.add('hidden');
                inputElement.value = '';
                inputElement.disabled = false;
                isWrong = false;
                nextQuestion();
            }, 375);
        }

        // ìˆ«ìë§Œ ì…ë ¥ë˜ë„ë¡ ì œí•œ (ì¼ë°˜ ìˆ«ìí‚¤ + ë„˜ë²„íŒ¨ë“œ)
        document.getElementById('answer').addEventListener('keydown', (e) => {
            // ìˆ«ì(0-9), ë°±ìŠ¤í˜ì´ìŠ¤, Delete, Tab, Arrow keys, Enter í—ˆìš©
            const allowedKeys = ['Backspace', 'Delete', 'Tab', 'ArrowLeft', 'ArrowRight', 'ArrowUp', 'ArrowDown', 'Enter'];
            const isNumber = (e.key >= '0' && e.key <= '9');
            // ë„˜ë²„íŒ¨ë“œ í™•ì¸ (Numpad0 ~ Numpad9)
            const isNumpad = e.code && e.code.startsWith('Numpad') && e.code.length === 7 && 
                            e.code[6] >= '0' && e.code[6] <= '9';
            const isAllowed = allowedKeys.includes(e.key);
            
            if (!isNumber && !isNumpad && !isAllowed) {
                e.preventDefault();
            }
        });

        // ì…ë ¥ í•„í„°ë§ (ë¶™ì—¬ë„£ê¸° ë“± ë°©ì§€)
        document.getElementById('answer').addEventListener('input', (e) => {
            // ìˆ«ìê°€ ì•„ë‹Œ ë¬¸ì ì œê±°
            e.target.value = e.target.value.replace(/[^0-9]/g, '');
        });

        document.getElementById('answer').addEventListener('input', (e) => {
            const userInputString = e.target.value;
            const userAnswer = parseInt(userInputString);
            
            if (!isNaN(userAnswer) && userInputString !== '') {
                // ê³µí†µ ì •ë‹µ ì²´í¬ í•¨ìˆ˜ ì‚¬ìš©
                const result = checkAnswer(userAnswer, userInputString);
                
                if (result.isCorrect) {
                    // ì •ë‹µ ì²˜ë¦¬
                    handleCorrectAnswer();
                } else if (result.isWrong) {
                    // ì˜¤ë‹µ ì²˜ë¦¬
                    handleWrongAnswer(e.target);
                }
                // result.isWrong === falseì´ë©´ ì•„ì§ ì…ë ¥ ì¤‘ì´ë¯€ë¡œ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ
            }
        });

        function startTimer() {
            timerInterval = setInterval(() => {
                timeLeft--;
                document.getElementById('time-value').innerText = timeLeft;
                
                const gameDiv = document.getElementById('game');
                if (timeLeft <= 10) {
                    gameDiv.style.borderColor = '#f87171';
                    if (timeLeft <= 5) {
                        gameDiv.style.animation = 'pulse 0.5s infinite';
                    }
                }
                
                if (timeLeft <= 0) {
                    endGame();
                }
            }, 1000);
        }

        async function endGame() {
            clearInterval(timerInterval);
            document.getElementById('game').classList.add('hidden');
            document.getElementById('result').classList.remove('hidden');
            
            const stats = scoring.getStats();
            document.getElementById('final-score').innerText = `${stats.score}ì `;
            document.getElementById('final-correct').innerText = `ë§ì¶˜ ê°œìˆ˜: ${stats.correctCount}ê°œ`;
            document.getElementById('final-accuracy').innerText = `ì •ë‹µë¥ : ${stats.accuracy}%`;
            
            // ë­í‚¹ì— ì¶”ê°€
            console.log('ë­í‚¹ ì¶”ê°€ ì‹œì‘:', { username: currentUsername, score: stats.score, correctCount: stats.correctCount });
            await addToRanking(currentUsername, stats.score, stats.correctCount);
            
            // Firebase ë™ê¸°í™”ë¥¼ ìœ„í•´ ì•½ê°„ì˜ ì§€ì—° í›„ ë­í‚¹ ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸°
            await new Promise(resolve => setTimeout(resolve, 800));
            
            // ë­í‚¹ ë‹¤ì‹œ ê°€ì ¸ì˜¤ê¸° (ìµœì‹  ìƒíƒœ)
            const ranking = await getRanking();
            console.log('ë­í‚¹ ê°€ì ¸ì˜¤ê¸° ì™„ë£Œ, ì´ ê°œìˆ˜:', ranking.length);
            
            // í˜„ì¬ ê¸°ë¡ì˜ ë­í‚¹ ìˆœìœ„ ì°¾ê¸°
            const currentRank = findCurrentRank(ranking, currentUsername, stats.score, stats.correctCount);
            console.log('í˜„ì¬ ë­í‚¹ ìˆœìœ„:', currentRank);
            
            // ë­í‚¹ í‘œì‹œ (ìµœëŒ€ 10ê°œ)
            await displayRanking();
            
            // ìµœê³  ê¸°ë¡ ì €ì¥ (ì ìˆ˜ ê¸°ì¤€)
            let bestScore = parseInt(localStorage.getItem('bestMathScore') || '0');
            let bestCount = parseInt(localStorage.getItem('bestMathCount') || '0');
            
            let isNewPersonalRecord = false;
            if (stats.score > bestScore) {
                localStorage.setItem('bestMathScore', stats.score);
                bestScore = stats.score;
                isNewPersonalRecord = true;
            }
            if (stats.correctCount > bestCount) {
                localStorage.setItem('bestMathCount', stats.correctCount);
                bestCount = stats.correctCount;
                isNewPersonalRecord = true;
            }
            
            // ìƒí™©ì— ë§ëŠ” ë©˜íŠ¸ ìƒì„±
            let message = '';
            if (isNewPersonalRecord && currentRank === 1) {
                message = `ğŸŠ <span class="text-pink-500 font-bold">ê°œì¸ ìµœê³  ê¸°ë¡ ê²½ì‹  + 1ë“± ë‹¬ì„±!</span><br>ìµœê³  ì ìˆ˜: ${bestScore}ì  | ìµœê³  ê°œìˆ˜: ${bestCount}ê°œ`;
                confetti({ 
                    particleCount: 200, 
                    spread: 120, 
                    origin: { y: 0.5 },
                    colors: ['#a855f7', '#ec4899', '#f472b6', '#c084fc']
                });
            } else if (isNewPersonalRecord) {
                if (currentRank > 0 && currentRank <= 10) {
                    message = `ğŸŠ <span class="text-pink-500 font-bold">ê°œì¸ ìµœê³  ê¸°ë¡ ê²½ì‹ !</span><br>ìµœê³  ì ìˆ˜: ${bestScore}ì  | ìµœê³  ê°œìˆ˜: ${bestCount}ê°œ<br>ë­í‚¹: ${currentRank}ë“±`;
                } else {
                    message = `ğŸŠ <span class="text-pink-500 font-bold">ê°œì¸ ìµœê³  ê¸°ë¡ ê²½ì‹ !</span><br>ìµœê³  ì ìˆ˜: ${bestScore}ì  | ìµœê³  ê°œìˆ˜: ${bestCount}ê°œ`;
                }
                confetti({ 
                    particleCount: 200, 
                    spread: 120, 
                    origin: { y: 0.5 },
                    colors: ['#a855f7', '#ec4899', '#f472b6', '#c084fc']
                });
            } else if (currentRank > 0 && currentRank === 1) {
                message = `ğŸ¥‡ <span class="text-yellow-500 font-bold">1ë“± ë‹¬ì„±!</span><br>ê°œì¸ ìµœê³  ì ìˆ˜: ${bestScore}ì  | ìµœê³  ê°œìˆ˜: ${bestCount}ê°œ`;
                confetti({ 
                    particleCount: 150, 
                    spread: 100, 
                    origin: { y: 0.5 },
                    colors: ['#fbbf24', '#f59e0b', '#d97706']
                });
            } else if (currentRank > 0 && currentRank <= 3) {
                message = `ğŸ† <span class="text-orange-500 font-bold">${currentRank}ë“± ë‹¬ì„±!</span><br>ê°œì¸ ìµœê³  ì ìˆ˜: ${bestScore}ì  | ìµœê³  ê°œìˆ˜: ${bestCount}ê°œ`;
            } else if (currentRank > 0 && currentRank <= 10) {
                message = `âœ¨ <span class="text-purple-500 font-bold">${currentRank}ë“±!</span><br>ê°œì¸ ìµœê³  ì ìˆ˜: ${bestScore}ì  | ìµœê³  ê°œìˆ˜: ${bestCount}ê°œ`;
            } else {
                message = `ê°œì¸ ìµœê³  ì ìˆ˜: ${bestScore}ì <br>ê°œì¸ ìµœê³  ê°œìˆ˜: ${bestCount}ê°œ`;
            }
            
            document.getElementById('best-score').innerHTML = message;
        }
    </script>
</body>
</html>